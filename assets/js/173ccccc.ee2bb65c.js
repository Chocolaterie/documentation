"use strict";(self.webpackChunkschool_learn=self.webpackChunkschool_learn||[]).push([[340],{3632:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>p,frontMatter:()=>s,metadata:()=>l,toc:()=>c});var t=r(7624),i=r(2172);const s={sidebar_position:1},a="JWT",l={id:"spring-security/course/jwt-filter",title:"JWT",description:"D\xe9pendances",source:"@site/docs/spring-security/course/jwt-filter.md",sourceDirName:"spring-security/course",slug:"/spring-security/course/jwt-filter",permalink:"/documentation/docs/spring-security/course/jwt-filter",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/spring-security/course/jwt-filter.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"JWT",permalink:"/documentation/docs/spring-security/course/jwt-01"},next:{title:"AI/Python",permalink:"/documentation/docs/category/aipython"}},o={},c=[{value:"D\xe9pendances",id:"d\xe9pendances",level:2},{value:"G\xe9n\xe9rer un token",id:"g\xe9n\xe9rer-un-token",level:2},{value:"Tester un token",id:"tester-un-token",level:2},{value:"Externaliser l&#39;acc\xe8s \xe0 la cl\xe9 secr\xe8te",id:"externaliser-lacc\xe8s-\xe0-la-cl\xe9-secr\xe8te",level:2},{value:"Filter (Middleware)",id:"filter-middleware",level:2},{value:"Passer le middleware (donc ok) :",id:"passer-le-middleware-donc-ok-",level:3},{value:"On ne passe pas le middleware (donc pas ok) :",id:"on-ne-passe-pas-le-middleware-donc-pas-ok-",level:3},{value:"Utiliser/Activer notre Filter",id:"utiliseractiver-notre-filter",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.M)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"jwt",children:"JWT"}),"\n",(0,t.jsx)(n.h2,{id:"d\xe9pendances",children:"D\xe9pendances"}),"\n",(0,t.jsx)(n.p,{children:"Dans le build.gradle"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"// Jwt\nimplementation 'io.jsonwebtoken:jjwt-api:0.12.6'\nruntimeOnly 'io.jsonwebtoken:jjwt-impl:0.12.6'\nruntimeOnly 'io.jsonwebtoken:jjwt-jackson:0.12.6'\n"})}),"\n",(0,t.jsx)(n.h2,{id:"g\xe9n\xe9rer-un-token",children:"G\xe9n\xe9rer un token"}),"\n",(0,t.jsx)(n.p,{children:"Le code java isol\xe9, natif pour g\xe9n\xe9rer un token:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// Pour genere un token\n// -- la date ou ca \xe9t\xe9 cr\xe9e (IssueAt)\n// -- une date d'expiration (Expiration)\n// -- une donn\xe9e subjectif (Subject)\n// -- l'algo pour crypter (HS256)\n// -- la cl\xe9 secr\xeate\n\n// -- temps de vie du token\nDate tokenLifetime = new Date(System.currentTimeMillis() + (1000 * 60 * 60) * 1);\n\n// Le code qui genere le token\nString token = Jwts.builder()\n    .setSubject(\"quelquun@gmail.com\")\n    .issuedAt(new Date(System.currentTimeMillis()))\n    .setExpiration(tokenLifetime)\n    .signWith(getKey(), SignatureAlgorithm.HS256)\n    .compact();\n"})}),"\n",(0,t.jsx)(n.h2,{id:"tester-un-token",children:"Tester un token"}),"\n",(0,t.jsx)(n.p,{children:"Un exemple de code java pour tester un token:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// R\xe9cup\xe9rer le token dans le header authorization\n// On substring 7 caract\xe8res car le header contient "Bearer tontoken"\nString token = authorization.substring(7);\n\ntry {\n   // Outil pour r\xe9cup\xe9rer le token (d\xe9chiffrer)\n    JwtParser jwtParser = Jwts.parser().setSigningKey(key).build();\n\n    // -- r\xe9cup\xe9rer les claims de mon token (claims => toutes les info)\n    Claims claims = jwtParser.parseSignedClaims(token).getBody();\n    \n    // R\xe9cup\xe9rer la date\n    // 1: Version abstraite\n    // Function<Claims, Date> expirationFunction = Claims::getExpiration;\n    // Date expirationDate = expirationFunction.apply(claims);\n    // 2: Version explicite\n    Date expirationDate = claims.getExpiration();\n    \n } catch (Exception e) {\n    // Si la date d\'expiration est depass\xe9 alors\n    // Si exception jwt de type expiration\n    if (e instanceof ExpiredJwtException){\n        return "Token expir\xe9";\n    }\n\n    // Si token malform\xe9\n    if (e instanceof MalformedJwtException){\n        return "Token malform\xe9";\n    }\n\n    return "Erreur inconnue";\n}\n\nreturn "Token valide";\n'})}),"\n",(0,t.jsx)(n.h2,{id:"externaliser-lacc\xe8s-\xe0-la-cl\xe9-secr\xe8te",children:"Externaliser l'acc\xe8s \xe0 la cl\xe9 secr\xe8te"}),"\n",(0,t.jsx)(n.p,{children:"Voici un exemple pour d\xe9porter l'acc\xe8s \xe0 la cl\xe9 secr\xe8te avec la valeur de la cl\xe9 stocker dans un fichier config"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'/**\n * R\xe9cup\xe9rer la valeur de app.jwt.secret dans application.properties\n */\n@Value("${app.jwt.secret}")\nprivate String SECRET_KEY;\n\nprivate Key getSecretKey() {\n    // convertir un string en base 64\n    byte[] keyBytes = Decoders.BASE64.decode(SECRET_KEY);\n    // convertir une base 64 en Key\n    Key key = Keys.hmacShaKeyFor(keyBytes);\n\n    return key;\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"Evidement cela veut dire que dans votre application.properties (dans notre cas en tout cas) vous avez bien :"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"app.jwt.secret=69636e783529213d5722613b2b336c793371666524684a3445226e5573\n"})}),"\n",(0,t.jsx)(n.h2,{id:"filter-middleware",children:"Filter (Middleware)"}),"\n",(0,t.jsx)(n.p,{children:"Filter c'est un middleware (comme un pare-feu) qui permet de faire du traitement entre chaque requ\xeate http"}),"\n",(0,t.jsx)(n.p,{children:"On avait un Filter nomm\xe9 :"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public class JwtAuthFilter extends OncePerRequestFilter\n"})}),"\n",(0,t.jsx)(n.p,{children:"Rappel interpr\xe9ter chaque requ\xeate dans le Filter, surcharger :"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"@Override\nprotected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {\n"})}),"\n",(0,t.jsx)(n.p,{children:"Exemple pour r\xe9pondre \xe0 ces besoins :"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Verifier qu'on a envoyer un token valide quand on est en dehors de l'url ",(0,t.jsx)(n.code,{children:"api/create-token"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'@Override\nprotected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {\n    // Si l\'url est different de /api/create-token -> verifier le token\n    String url = request.getRequestURI();\n\n    if (!url.startsWith("/api/create-token")) {\n        // R\xe9cup\xe9rer le token\n        String token = request.getHeader("Authorization");\n\n        // Appeler notre service qui check le token\n        ServiceResponse<Boolean> serviceResponse = authService.checkToken(token);\n\n        // Si pas bon (!= 202 code m\xe9tier)\n        if (!serviceResponse.code.equals("202")) {\n            // Forcer la r\xe9ponse http \xe0 \xeatre en JSON\n            response.setContentType("application/json");\n\n            objectMapper.writeValue(response.getWriter(), serviceResponse);\n            return;\n        }\n    }\n\n    // passer (Oui/Ok)\n    filterChain.doFilter(request, response);\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"passer-le-middleware-donc-ok-",children:"Passer le middleware (donc ok) :"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"filterChain.doFilter(request, response);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"on-ne-passe-pas-le-middleware-donc-pas-ok-",children:"On ne passe pas le middleware (donc pas ok) :"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"return\n"})}),"\n",(0,t.jsx)(n.p,{children:"Attention dans le cas ou on ne passe pas, il est recommand\xe9 d'avoir une r\xe9ponse http pertinente :"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// Forcer la r\xe9ponse http \xe0 \xeatre en JSON\nresponse.setContentType("application/json");\n\n// Ecrire dans la r\xe9ponse http (dans notre cas du m\xe9tier)\nobjectMapper.writeValue(response.getWriter(), serviceResponse);\n'})}),"\n",(0,t.jsx)(n.h2,{id:"utiliseractiver-notre-filter",children:"Utiliser/Activer notre Filter"}),"\n",(0,t.jsx)(n.p,{children:"Il faut injecter votre filter dans votre config Spring security, example :"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"@Configuration\n@EnableWebSecurity\npublic class SpringSecurityConfig {\n    \n    private final JwtAuthFilter jwtAuthFilter;\n\n    public SpringSecurityConfig(JwtAuthFilter jwtAuthFilter) {\n        this.jwtAuthFilter = jwtAuthFilter;\n    }\n    ...\n"})})]})}function p(e={}){const{wrapper:n}={...(0,i.M)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},2172:(e,n,r)=>{r.d(n,{I:()=>l,M:()=>a});var t=r(1504);const i={},s=t.createContext(i);function a(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);